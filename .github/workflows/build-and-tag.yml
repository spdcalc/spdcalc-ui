# GitHub Action to validate build and tag for deployment
# Triggers production deployment workflow via build-* tags

name: Build and Tag

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "build"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3
      - name: Install RSW from cargo
        run: cargo install rsw
      - uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install
      - run: bun run build

  tag:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Grace period (cancellable)
        run: |
          echo "Waiting 2 minutes before tagging..."
          echo "Push again to cancel this and restart the timer."
          sleep 120
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get next build number
        id: build_number
        run: |
          # Get the latest build-* tag number, default to 0 if none exist
          LATEST=$(git tag -l 'build-*' | sed 's/build-//' | sort -n | tail -1)
          NEXT=$((${LATEST:-0} + 1))
          echo "number=$NEXT" >> $GITHUB_OUTPUT
      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "build-${{ steps.build_number.outputs.number }}"
          git push origin "build-${{ steps.build_number.outputs.number }}"
